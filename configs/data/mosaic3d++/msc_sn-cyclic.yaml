# @package data
defaults:
  - mosaic3d++/msc_sn

train_dataset:
  _target_: src.data.concat_dataset.ConcatDataset
  _partial_: true
  ignore_label: -100
  conditions: ["ScanNet"]
  repeat: 4
  datasets:
    - _target_: src.data.scannet.dataset.ScanNetDataset
      _partial_: true
      data_dir: /datasets/scannet_hf
      split: train
      caption_dir: /datasets/mosaic3d++
      caption_subset: caption-mc.osprey.scannet-125k.cyclic-check
      segment_dir: /datasets/mosaic3d++
      segment_subset: mask_clustering.cropformer.scannet-125k
      load_embeddings: true
      embedding_filename: embeddings-gathered.recap_clip
      object_num_max: 300
      ignore_label: -100
      repeat: 1
      transforms:
        - type: CenterShift
          apply_z: true
        - type: RandomScale
          scale: [0.9, 1.1]
        - type: Copy
          keys_dict:
            coord: origin_coord
        - type: ContrastiveViewsGenerator
          view_keys: ["coord", "color", "origin_coord", "caption_data"]
          view_trans_cfg:
            - type: RandomRotate
              p: 1
              angle: [-1, 1]
              center: [0, 0, 0]
              axis: "z"
            - type: RandomRotate
              p: 1
              angle: [-0.015625, 0.015625]
              axis: "x"
            - type: RandomRotate
              p: 1
              angle: [-0.015625, 0.015625]
              axis: "y"
            - type: RandomFlip
              p: 0.5
            - type: RandomJitter
              sigma: 0.005
              clip: 0.02
            - type: RandomColorJitter
              brightness: 0.4
              contrast: 0.4
              saturation: 0.2
              hue: 0.02
              p: 0.8
            - type: ChromaticJitter
              p: 0.95
              std: 0.05
            - type: GridSample
              grid_size: ${data.collate_fn.grid_size}
              hash_type: fnv
              mode: train
              keys: ["coord", "color", "origin_coord"]
              return_grid_coord: true
            - type: SphereCrop
              point_max: 102400
              mode: random
            - type: CenterShift
              apply_z: false
            - type: NormalizeColor
        - type: Add
          keys_dict:
            condition: ScanNet
        - type: ToTensor
        - type: Collect
          keys:
            [
              "view1_origin_coord",
              "view1_grid_coord",
              "view1_coord",
              "view1_color",
              "view1_caption_data",
              "view2_origin_coord",
              "view2_grid_coord",
              "view2_coord",
              "view2_color",
              "condition",
            ]
          offset_keys_dict:
            view1_offset: view1_coord
            view2_offset: view2_coord
            pc_count: origin_coord
          view1_feat_keys: ["view1_color"]
          view2_feat_keys: ["view2_color"]
